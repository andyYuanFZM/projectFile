# Chain33中实现DPos共识的方案

## 1.1 需求背景
Chain33区块链支持可插拔的插件化设计，目前已经支持POS， tendermint, raft， pbft等共识。实现DPos共识主要是丰富chain33的插件库，给使用chain33的用户更多的选择。

## 1.2 方案选型
调查了市面上使用DPOS共识的区块链，包括EOS, asch, Lisk, VNT, NAS等。 总体上都是遵循DPOS共识协议（最早由比特股社区提出），
区别在于实现的上一些细节，有些是代理节点依次轮流出块，有些是代理节点连续生产几个块后再切换成另一个代理节点; 有些在DPOS的基础上增加了PBFT的机制作为性能和安全性改进; 有些是代理节点的数目不同等等。

综合性能和成熟度方面的考量，本方案使用BFT+DPOS的共识协议，来实现chain33的共识插件。

BFT（拜占庭容错）: 是分布式系统对错误容忍度的一种协议，如果一个分布式系统能够容忍包含硬件错误，网络问题，黑客攻击，节点劫持等问题，就可以认为这个系统达到了拜占庭（BFT）容错。
DPoS(Delegated Proof of Stake) 委托权益证明：算法中，区块由固定数量的生产者（或者教见证人）生产，现在经常听到的BP或者超级节点其实就是指代DPoS算法中的区块生产者。在网络中的用户，可以将自己的票投给这些生产者，让其代替自己行事区块打包的权利，其机制类似于议会制度或人民代表大会制度。

1.2.1 选型原因分析
DPOS共识的逻辑：
1. 由生产者列表和时间偏移共同决定当前由谁来打包区块。  -- 解决谁来打包区块
2. 按照固定的时间间隔来打包区块。   -- 解决何时打包区块
3. 通过区块中附带的签名和生产者的公钥验证区块的合法性。  -- 解决如何验证区块的合法性

BFT共识的逻辑：
引入BFT共识，目的是对DPOS的安全性进行一个增强，使它能容忍拜占庭错。 它对以上DPOS逻辑中的第3点进行改变，区块的验证不是单一的签名验证，而引入全节点投票确认的方式。

## 1.3 实现要点

### 一期计划：

1.3.1 共识逻辑实现
DPOS部分：
1. 每隔1秒（可配置）出一个块，生产节点随机出块，每一个生产节点出6个块后再切换至另一个生产节点。
2. 当某个生产节点在1秒内没有成功出块，则跳过该块。

BFT部分：
1. 当前生产者将当前产生的区块广播， 只广播区块的元数据，不包含交易（交易量大的情况下，广播全区块占用流量比较大）。
2. 其它生产者收到block后，做合法性验证。 并且广播prepare消息，可以带上区块高度，区块hash,以及本节点的签名等信息。
3. 生产节者手机prepare消息，当收到超过2f+1个不同节点的prepare消息后，进入到prepare状态，并且广播commit消息。同样是带上区块高度，区块hash, 以及本节点的签名信息。
4. 每个生产者收到超过2f+1个不同节点的commit消息，就进入到commited阶段。 打包节点将区块送入执行器模块，执行，落盘并且通过p2p广播给其它节点。
5. 系统设置超时定时器，当定时器超时，放弃本次共识。

1.3.2. P2P传输实现
1.  可以参考tendermint共识的实现方式
2.  或者可以采用go的libp2p来实现

### 二期计划
增加节点投票能力，包括实现投票合约，投票系统（投票客户端）等